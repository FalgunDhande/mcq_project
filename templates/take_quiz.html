{% extends "base.html" %}{% block content %}
<h2>{{ quiz.title }}</h2>
<p>Time Remaining: <strong id="countdown" data-deadline="{{ deadline_iso }}"></strong></p>
<form id="quiz-form" method="post" action="{{ url_for('submit_quiz', quiz_id=quiz.id) }}">
<input type="hidden" name="attempt_id" value="{{ attempt_id }}">
{% for q in questions %}
<article><h4>Q{{ loop.index }}. {{ q.text }}</h4>
{% for opt,label in [('A', q.option_a), ('B', q.option_b), ('C', q.option_c), ('D', q.option_d)] %}
<label><input type="radio" name="q_{{ q.id }}" value="{{ opt }}" onchange="autoSave({{ q.id }}, this.value)"> {{ opt }}) {{ label }}</label><br>
{% endfor %}
<label><input type="checkbox" onchange="autoSave({{ q.id }}, null, this.checked)"> Flag</label>
<label>Note <input type="text" onblur="autoSave({{ q.id }}, null, null, this.value)" placeholder="Add note"></label>
</article>
{% endfor %}
<button type="submit">Submit</button></form>
<script>
const attemptId={{ attempt_id }};
function autoSave(qid, sel=null, flag=null, note=null){
  const fd=new FormData(); fd.append('question_id', qid);
  if(sel!==null) fd.append('selected', sel);
  if(flag!==null) fd.append('flag','1');
  if(note!==null) fd.append('note', note);
  fetch(`/attempt/${attemptId}/autosave`, {method:'POST', body:fd});
}
document.addEventListener('DOMContentLoaded',()=>{
 const el=document.getElementById('countdown'); if(!el) return;
 const d=new Date(el.dataset.deadline).getTime();
 const tick=()=>{const n=Date.now(), diff=Math.max(0,d-n),
 s=Math.floor(diff/1000), m=Math.floor(s/60), h=Math.floor(m/60);
 el.textContent=`${String(h).padStart(2,'0')}:${String(m%60).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
 if(diff<=0){document.getElementById('quiz-form')?.submit(); return;} setTimeout(tick,500);}; tick();});
</script>
{% endblock %}